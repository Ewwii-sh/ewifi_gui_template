#!/bin/bash

ssid="$1" # first argument passed to the script
template_dir="$XDG_RUNTIME_DIR/ewwii_ewifi_gui_template"

mkdir -p "$template_dir"

# Function to update network info in the GUI
update_net_info() {
    nmcli dev wifi rescan
    NEW_NET_INFO=$(nmcli -t -f SSID,SIGNAL,SECURITY dev wifi)
    ewwii update -w "wifi_gui" --inject-vars net_info="$NEW_NET_INFO" --config .
}

# Check if a connection already exists
if nmcli -t -f NAME connection show | grep -Fxq "$ssid"; then
    if nmcli dev wifi connect "$ssid"; then
        echo  "updating net info"
        update_net_info
    fi
else
    # get security type of the network
    security=$(nmcli -t -f SSID,SECURITY dev wifi | grep -Fx "$ssid" | cut -d: -f2)

    if [[ -z "$security" || "$security" == "--" ]]; then
        # Open network, connect directly
        if nmcli dev wifi connect "$ssid"; then
            update_net_info
        fi
    else
        # Secured network, need password
        ewwii open password_dialog --config .

        # Wait until password is provided (read from file)
        password_file="$template_dir/connect_to.txt"
        while [[ ! -s "$password_file" ]]; do
            sleep 0.1
        done
        password=$(cat "$password_file")

        # Connect with password
        if nmcli dev wifi connect "$ssid" password "$password"; then
            update_net_info
        fi
    fi
fi

